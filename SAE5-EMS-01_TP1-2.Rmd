---
  title: "TP1-2: Etude de cas guidée : santé mentale chez la jeunesse americaine"
output:
  word_document:
  toc: yes
number_sections: true
pdf_document:
  toc: no
number_sections: true
pandoc_args:
  includes:
  in_header: header.tex
---

2.3

```{r setup, include=FALSE}
library(knitr)
options(crayon.enabled = NULL)
knitr::opts_chunk$set(include = TRUE, comment = NA, echo = TRUE,
                      message = FALSE, warning = FALSE, cache = FALSE,
                      fig.align = "center", out.width = '90%')
rmarkdown:::perf_timer_reset_all()
rmarkdown:::perf_timer_start("render")
```

```{r}
library(here)
library(rvest)
library(dplyr)
library(magrittr)
library(stringr)
library(tidyr)
library(tibble)
library(purrr)
library(ggplot2)
library(directlabels)
library(scales)
library(forcats)
library(ggthemes)
library(rstatix)
library(cowplot)
# install.packages("OCSdata")
library(OCSdata) #https://github.com/opencasestudies/OCSdata OpenCase study data
library(fs) # For creating directories
```

3.2

```{r}
NSDUH_url <- "https://www.samhsa.gov/data/sites/default/files/cbhsq-reports/NSDUHDetailedTabs2018R2/NSDUHDetTabsSect11pe2018.htm"
NSDUH_url <- "https://www.opencasestudies.org/ocs-bp-youth-mental-health/data/raw/samhsa.gov_2020_tables.htm"
```

```{r}
table11.1a <- NSDUH_url %>%
  xml2::read_html() %>%
  rvest::html_elements(xpath = "/html/body/div[4]/div[1]/table") %>%
  rvest::html_table()
table11.1a <- table11.1a[[1]]
```

3.3

```{r}
scraper <- function(XPATH){
table <- NSDUH_url %>%
read_html() %>%
html_elements(xpath = XPATH) %>%
html_table()
output <- table[[1]]
output
}
```

```{r}
table11.1b <- scraper(XPATH = "/html/body/div[4]/div[2]/table")
table11.2a <- scraper(XPATH = '/html/body/div[4]/div[3]/table')
table11.2b <- scraper(XPATH = '/html/body/div[4]/div[4]/table')
table11.3a <- scraper(XPATH = '/html/body/div[4]/div[5]/table')
table11.3b <- scraper(XPATH = '/html/body/div[4]/div[6]/table')
table11.4a <- scraper(XPATH = '/html/body/div[4]/div[7]/table')
table11.4b <- scraper(XPATH = '/html/body/div[4]/div[8]/table')
```

```{r}
fs::dir_create(here("data", "imported")) #create the folders
save(table11.1a, table11.1b, table11.2a, table11.2b,
table11.3a, table11.3b, table11.4a, table11.4b,
file = here::here("data", "imported", "imported_data.rda"))
```

3.4.1

```{r}
load(file = here::here("data", "imported", "imported_data.rda"))
```

3.4.2

```{r}
class(table11.1a)
```

```{r}
table11.1a %>%
  dplyr::as_tibble() %>%
  tail(n = 1)
```

```{r}
table11.1a %>%
  dplyr::as_tibble() %>%
  dplyr::select(`2004`) %>%
  tail(n = 1)
```

```{r}
legend <- table11.1a %>%
as_tibble() %>%
select(`2004`) %>%
tail(n = 1)
```

```{r}
table11.1a %>%
  dplyr::as_tibble() %>%
  dplyr::slice(n())
```

```{r}
table11.1a %<>%
  dplyr::as_tibble() %>%
  slice(1:(n()-1))
```

```{r}
slice_head(table11.1a, n = (length(pull(table11.1a, `2002`))))
```

```{r}
dplyr::pull(legend, `2004`)
```

```{r}
table11.1a %<>%
# apply na_if to all columns
  mutate(across(everything(), ~dplyr::na_if(.x, "nc"))) %>%
  mutate(across(everything(), ~dplyr::na_if(.x, "--"))) %>%
  mutate(across(everything(), ~dplyr::na_if(.x, ""))) %>%
  mutate(across(everything(), ~dplyr::na_if(.x, "*")))
  head(table11.1a)

```

```{r}
colnames(table11.1a)
```

```{r}
table11.1a %<>%
  dplyr::rename(MHS_setting = `Setting Where Mental Health ServiceWas Received`)
head(table11.1a)
```

```{r}
table11.1a %>%
  pull(MHS_setting)
```

```{r}
table11.1a %<>%
  mutate(MHS_setting =
  str_remove_all(string = MHS_setting,
  pattern = "[:digit:]|\r\n|[:punct:]|"))
head(table11.1a)
```

```{r}
table11.1a %<>%
  mutate(MHS_setting =
  str_replace_all(string = MHS_setting,
  pattern = "[:blank:]{1,}",
  replacement = " "))
head(table11.1a)
```

```{r}
table11.1a %<>%
  mutate(dplyr::across(.cols = -MHS_setting,
  stringr::str_remove_all, "a|,"))
head(table11.1a)
```

```{r}
table11.1a %<>%
  mutate(across(.cols =-MHS_setting, as.numeric))
head(table11.1a)
```

```{r}
table11.1a %<>%
  mutate(type = c(rep("Specialty", 9), 
                  rep("Nonspecialty", 11))) %>%
  mutate(subtype = c("Specialty_total", 
                     rep("Outpatient", 5), 
                     rep("Inpatient", 3), 
                     "Nonspecialty_total", 
                     rep("Education", 3), 
                     rep("General_medicine", 2),
                     rep("Juvenile_Justice", 2), 
                     rep("Child_Welfare", 2), 
                     "combination"))
```

```{r}
table11.1a %<>%
  mutate(short_label = c("Specialty total", "Outpatient total", "Therapist",
  "Clinic", "Day program", "In-home Therapist", "Inpatient total",
  "Hospital", "Residential Center", "Nonspecialty total",
  "School total", "School Therapist", "School Program",
  "General Medicine", "Family Dr", "Justice System", "Justice System",
  "Welfare", "Fostercare", "Specialty Combination"))
```

```{r}
table11.1a %<>%
dplyr::filter(MHS_setting != "General_Medicine") %>%
dplyr::filter(MHS_setting != "Juvenile_Justice") %>%
dplyr::filter(MHS_setting != "Child_Welfare")
head(table11.1a)
```

```{r}
dim(table11.1a)
```

```{r}
table11.1a %<>%
  tidyr::pivot_longer(cols = contains("20"),
  names_to = "Year",
  values_to = "Number") %>%
  mutate(Year = as.numeric(Year))
dim(table11.1a)
```

```{r}
head(table11.1a)
```

3.3.4

```{r}
# table11.1a %<>%
# # make the table into a tibble
#   dplyr::as_tibble() %>%
# # remove the last row by only keeping the first through the second to last
#   slice(1:(n() - 1)) %>%
# # make the "nc" values "NA" instead
#   dplyr::na_if("nc") %>%
#   dplyr::na_if("--") %>%
#   dplyr::na_if("") %>%
#   dplyr::na_if("*") %>% 
# # rename the column to the shorter MHS_setting name
#   dplyr::rename(MHS_setting = 
#                   `Setting Where Mental Health ServiceWas Received`) %>%
# # remove numbers, carriage return, new lines, and punctuation marks from the values for the MHS_setting column
#   mutate(MHS_setting = 
#          str_remove_all(string = MHS_setting, 
#                        pattern = "[:digit:]|\r\n|[:punct:]|")) %>%
# # replace the white spaces with a single space
#   mutate(MHS_setting = 
#          str_replace_all(string = MHS_setting,
#                         pattern = "[:blank:]{1,}", 
#                     replacement = " ")) %>%
# # remove "a" and commas from the values in the columns except the column called MHS_setting
#   mutate(dplyr::across(.cols = -MHS_setting,
#                 stringr::str_remove_all, "a|,")) %>%
# # make those columns numeric
#   mutate(across(-MHS_setting, as.numeric)) %>%
# # create a new type column with the values: "Specialty repeated 9 times followed by "Nonspecialty" repeated 11 times
#   mutate(type = c(rep("Specialty", 9), rep("Nonspecialty", 11))) %>%
# # create a new variable called subtype 
#   mutate(subtype =c("Specialty_total", 
#                     rep("Outpatient", 5), 
#                     rep("Inpatient", 3), 
#                     "Nonspecialty_total", 
#                     rep("Education", 3), 
#                     rep("General_medicine", 2),
#                     rep("Juvenile_Justice", 2),
#                     rep("Child_Welfare", 2), 
#                     "combination")) %>%
# # create a new variabel called short_label
#   mutate(short_label = c("Specialty total", "Outpatient total",
#                          "Therapist", "Clinic", "Day program", 
#                          "In-home Therapist", "Inpatient total",
#                          "Hospital", "Residential Center",
#                          "Nonspecialty total", "School total", 
#                          "School Therapist", "School Program", 
#                          "General Medicine", "Family Dr", 
#                          "Justice System", "Justice System",
#                          "Welfare", "Fostercare", 
#                          "Specialty Combination")) %>%
# # remove rows with General_Medicine as the value in the MHS_setting column because it is empty
#   dplyr::filter(MHS_setting != "General_Medicine") %>%
# # remove rows with Juvenile_Justice as the value in the MHS_setting column because it is empty
#   dplyr::filter(MHS_setting != "Juvenile_Justice") %>%
# # remove rows with Child_Welfare as the value in the MHS_setting column because it is empty
#   dplyr::filter(MHS_setting != "Child_Welfare") %>%
# # make the table in long format
#     tidyr::pivot_longer(cols = contains("20"),
#                         names_to = "Year",
#                         values_to = "Number") %>%
# # make the new Year variable to be numeric
#    mutate(Year = as.numeric(Year))
```

```{r}
function(TABLE, new_col, pivot_col){
  dplyr::as_tibble(TABLE) %>%
  #additional steps
    rename({{new_col}} := names(.)[1])
  #additional steps
}
```

```{r}
function(TABLE, new_col, pivot_col){
  # previous similar steps to modify and make table values numeric
    filter(rowSums(is.na(select(., is.numeric))) < 
             length(select(., is.numeric))) 
  }
```

```{r}
data_prep_settings <- function(TABLE, new_col, pivot_col){
# make the table a tibble
  dplyr::as_tibble(TABLE) %>%
# remove the last row
    slice(1:(n() - 1)) %>%
# make "nc" values NA etc.
  mutate(across(everything(), ~na_if(.x, "nc"))) %>%
  mutate(across(everything(), ~na_if(.x, "--"))) %>%
  mutate(across(everything(), ~na_if(.x, ""))) %>%
  mutate(across(everything(), ~na_if(.x, "*")))%>%
# rename the first column (names(.)[1]) to be what was specified with the new_col argument
    rename({{new_col}} := names(.)[1]) %>%
# remove the numbers and punctuation marks and carriage returns (\r) and new lines (\n) from the first column
    mutate({{new_col}} := 
        str_remove_all(string = pull(., {{new_col}}), 
                        pattern = "[:digit:]|\r\n|[:punct:]|")) %>%
# replace white spaces with a single space
    mutate({{new_col}} := 
        str_replace_all(string =pull(., {{new_col}}),
                         pattern = "[:blank:]{1,}", 
                         replacement = " ")) %>%
# remove "a" and , from the values for the columns that are not the first column (called new_col)
    mutate(dplyr::across(.cols = -{{new_col}},
                       stringr::str_remove_all, "a|,")) %>%
# make these columns numeric  (all the columns but the first column)
    mutate(across(-{{new_col}}, as.numeric)) %>%
# make a new variable called type with 9 values that are Specialty followed by 11 values of Nonspecialty
    mutate(type = c(rep("Specialty", 9), rep("Nonspecialty", 11))) %>%
# make a new variable called subtype with the following values repeated various times
    mutate(subtype = c("Specialty_total",
                       rep("Outpatient", 5),
                       rep("Inpatient", 3),
                       "Nonspecialty_total",
                       rep("Education", 3),
                       rep("General_medicine", 2),
                       rep("Juvenile_Justice", 2),
                       rep("Child_Welfare", 2),
                       "combination")) %>% 
# make a new variable called short_label to use as labels for plots for the data
    mutate(short_label = c("Specialty total", "Outpatient total",  
                           "Therapist", "Clinic", "Day program", 
                           "In-home Therapist", "Inpatient total",
                           "Hospital", "Residential Center",
                           "Nonspecialty total", "School total", 
                           "School Therapist", "School Program", 
                           "General Medicine", "Family Dr", 
                           "Justice System", "Justice System", 
                           "Welfare", "Fostercare", 
                           "Specialty Combination")) %>%
# remove rows were all the values are NA - 
# the number of `NA` values for a row should be less than the number of columns that could have `NA` values
  filter(rowSums(is.na(select(., is.numeric))) <
           length(select(., is.numeric))) %>%
# make the table into long format so that the year columns are collapsed together 
# the new value column is called what was specified with the "pivot_col" argument
  pivot_longer(cols = contains("20"),
               names_to = "Year", 
               values_to = pivot_col)%>%
# make the new "Year" variable numeric
  mutate(Year = as.numeric(Year))
}
```

```{r}
table11.1b <-data_prep_settings(TABLE = table11.1b,new_col = "MHS_setting",pivot_col = "Percent")
head(table11.1b)
```

3.3.4

```{r}
data_dem_settings <- function(TABLE){
  # make the table a tibble
  dplyr::as_tibble(TABLE) %>%
  # Remove the last row - keep only the 1st through 2nd to last rows
  slice(1:(n()-1)) %>%
  # change the values from "nc, --" etc to NA
  mutate(across(everything(), ~na_if(.x, "nc"))) %>%
  mutate(across(everything(), ~na_if(.x, "--"))) %>%
  mutate(across(everything(), ~na_if(.x, ""))) %>%
  mutate(across(everything(), ~na_if(.x, "*"))) %>%
  # rename the first column to be "Demographic"
  rename(Demographic := names(.)[1]) %>%
  # replace white spaces form the values of the "Demographic" variable with a single space
  mutate(Demographic := str_replace_all(string = pull(., Demographic),
                                        pattern = "[:blank:]{1,}", 
                                        replacement = " ")) %>%
  # replace values where there is a "1" in the "Demographic" variable to be "Age: 1"
  mutate(Demographic = str_replace(string = Demographic, 
                                   pattern = "1", 
                                   replacement = "Age: 1")) %>%
  # create a new variable called subgroup
  mutate(subgroup = c("Total", rep("Age", 4), 
                    rep("Gender", 3), rep("Race/Ethnicity", 9))) %>%
  # remove "a" and commas from the variables that have column names with "20" in them
  mutate(dplyr::across(.cols = contains("20"),
                       stringr::str_remove_all, "a|,")) %>%
  # make the variables with "20" in the names (the year variables) to be numeric
  mutate(across(contains("20"), as.numeric)) %>%
  # remove empty rows - rows were the number of NA values is equal to the number of numeric columns
  filter(rowSums(is.na(select(., is.numeric))) < length(select(., is.numeric)))
  }
```

```{r}
table11.2a <- data_dem_settings(TABLE = table11.2a)
table11.2a %<>% mutate(data_type = "Major_Depressive_Episode")
head(table11.2a)
table11.2b <- data_dem_settings(TABLE = table11.2b)
table11.2b %<>% mutate(data_type = "Major_Depressive_Episode")
head(table11.2b)
table11.3a <- data_dem_settings(TABLE = table11.3a)
table11.3a %<>% mutate(data_type = "Severe_Major_Depressive_Episode")
head(table11.3a)
table11.3b <- data_dem_settings(TABLE = table11.3b)
table11.3b %<>% mutate(data_type = "Severe_Major_Depressive_Episode")
head(table11.3b)
table11.4a <- data_dem_settings(TABLE = table11.4a)
table11.4a %<>% mutate(data_type = "Treatment")
head(table11.4a)
table11.4b <- data_dem_settings(TABLE = table11.4b)
table11.4b %<>% mutate(data_type = "Treatment")
head(table11.4b)
```

3.5

```{r}
data_dem_check <- function(TABLE){
# check that the data is a tibble
case_when(is_tibble(TABLE) ~ "Good!",
TRUE ~ "Not a tibble")
}
```

```{r}
test_that_should_fail <- c(1,2,3)
class(test_that_should_fail)
class(table11.1a)

data_dem_check(test_that_should_fail)
data_dem_check(table11.1a)
```

```{r}
data_dem_check <- function(TABLE){
# check that the last row does not contain "--" by..
#first grabbing only the last row
#pulling one of the years
case_when(TABLE %>% slice(n()) %>% pull(`2018`) %>%
# if it is detected print
str_detect(pattern = "-- = not available") ~ "Legend might still be there",
TRUE ~ "Good!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
tibble(tibble_check = case_when(is_tibble(table11.4a) ~ "Good!",
TRUE ~ "Not a tibble"),
legend_check = case_when(table11.4a %>% slice(n()) %>%pull(`2004`) %>%
# if it is detected print
str_detect(pattern = "--") ~ "Legend might still be there",
TRUE ~ "Good!"))
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(any(str_detect(TABLE, pattern = "nc|\\*|--"))
# if it is detected, print this:
~ "NA not fixed",
# if not detected, print this:
TRUE ~ "Good!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(names(TABLE)[1] == "Demographic" ~ "Good!",
TRUE ~ "check first column")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(any(str_detect(TABLE, pattern = "[:blank:]{2,}"))
~ "white spaces not fixed",
TRUE ~ "Good!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(any(str_detect(pull(TABLE,Demographic), pattern = "^1"))
# if it is detected print
~ "Age data not fixed!",
TRUE ~ "Good!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(any(names(TABLE) == "subgroup")
# if it is detected print
~ "Good",
TRUE ~ "No subgroup variable!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(
TABLE%>% select(-Demographic, -subgroup, -data_type) %>%
map_df(~str_detect(.x, pattern ="a|,")) %>%
rowSums(na.rm = TRUE) %>%
sum() == 0
~ "Good!",
TRUE ~ "There may be commas or the letter a in the year columns!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(sum(map_dbl(TABLE, is.numeric))== sum(str_count(names(TABLE), "20"))
# if it is detected print
~ "Good!",
TRUE ~ "Variables are not numeric!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
case_when(nrow(TABLE %>%filter(rowSums(is.na(select(., is.numeric))) > length(select(., is.numeric))))
>0
# if it is detected print
~ "There are empty rows ",
TRUE ~ "Good!")
}
data_dem_check(table11.4a)
```

```{r}
data_dem_check <- function(TABLE){
results <-tibble(tibble_check = case_when(is_tibble(TABLE) ~ "Good!",
                                                 TRUE ~ "Not a tibble"),
       legend_check = case_when(TABLE %>% slice(n()) %>%pull(`2018`) %>%
   # if it is detected print 
                          str_detect(pattern = "--")  ~ "Legend might still be there",
                                                 TRUE ~ "Good!"),
       NAs_check = case_when(any(str_detect(TABLE, pattern = "nc")) 
                                                      ~ "NA not fixed",
                                                 TRUE ~ "Good!"),
  firstcol_check = case_when(names(TABLE)[1] == "Demographic" 
                                                      ~ "Good!",
                                                 TRUE ~ "check first column"),
  white_space_check = case_when(any(str_detect(TABLE, pattern = "[:blank:]{2,}")) 
                                                      ~ "white spaces not fixed",
                                                 TRUE ~ "Good!"),
  age_data_check = case_when(any(str_detect(pull(TABLE,Demographic), pattern = "^1"))
                                                      ~ "Age data not fixed!",
                                                 TRUE ~ "Good!"),
  subgroup_check = case_when(any(names(TABLE) == "subgroup")
                                                      ~ "Good!",
                                                 TRUE ~ "No subgroup variable!"),
    a_comma_check = case_when(TABLE%>% select(-Demographic, -subgroup, -data_type) %>% 
                                      map_df(~(str_detect(.x, pattern ="a|,"))) %>%
                                           rowSums(na.rm = TRUE) %>% 
                                                sum() == 0
                                                       ~ "Good!",
                                                  TRUE ~ "There may be commas or the letter a in the year columns!"),
numeric_check = case_when(sum(map_dbl(TABLE, is.numeric))== sum(str_count(names(TABLE), "20"))
                                                     ~ "Good!",
                                                TRUE ~ "Variables are not numeric!"),
  empty_row_check = case_when(nrow(TABLE %>%filter(rowSums(is.na(select(., is.numeric))) > 
                                                     length(select(., is.numeric)))) >0 
                                                     ~ "There are empty rows ",
                                                TRUE ~ "Good!"))

ifelse(all(results == "Good!"),
       "Data looks good!", glimpse(results))
}

data_dem_check(table11.4a)
```

```{r}
tables_tocheck <-list(table11.2a, table11.2b, table11.3a, table11.3b, table11.4a, table11.4b)
tables_tocheck %>% map(data_dem_check)
```

```{r}
counts <- dplyr::bind_rows(table11.2a, table11.3a, table11.4a)
percents <- bind_rows(table11.2b, table11.3b, table11.4b)
counts %>% dplyr::distinct(data_type)
percents %>% distinct(data_type)
```

```{r}
counts %<>%
pivot_longer(cols = contains("20"),names_to = "Year",values_to = "Number") %>%
mutate(Year = as.numeric(Year))
percents %<>%
pivot_longer(cols = contains("20"),names_to = "Year",values_to = "Percent") %>%
mutate(Year = as.numeric(Year))
glimpse(counts)
glimpse(percents)
```

```{r}
percents %<>% mutate(Demographic = str_replace(string = Demographic,
pattern = "AIAN",
replacement = "American Indian and Alaska Native"))
percents %<>% mutate(Demographic = str_replace(string = Demographic,
pattern = "NHOPI",
replacement = "Native Hawaiian or Other Pacific Islander"))
counts %<>% mutate(Demographic = str_replace(string = Demographic,
pattern = "AIAN",
replacement = "American Indian and Alaska Native"))
counts %<>% mutate(Demographic = str_replace(string = Demographic,
pattern = "NHOPI",
replacement = "Native Hawaiian or Other Pacific Islander"))
```

```{r}
percents %>%
distinct(Demographic)%>%
pull(Demographic)
counts %>%
distinct(Demographic)%>%
pull(Demographic)
```

```{r}
# Ensure the directory exists
fs::dir_create(here("data", "wrangled"))
save(percents, counts, table11.1a, table11.1b,
file = here::here("data", "wrangled", "wrangled_data.rda"))
readr::write_csv(percents, path = here::here("data", "wrangled", "percents.csv"))
readr::write_csv(counts, path = here::here("data", "wrangled", "counts.csv"))
readr::write_csv(table11.1a, path = here::here("data", "wrangled", "table11.1a.csv"))
readr::write_csv(table11.1b, path = here::here("data", "wrangled", "table11.1b.csv"))
```

4.1

```{r}
load(file = here::here("data", "wrangled", "wrangled_data.rda"))
```

4.2

```{r}
percents %>%
filter(data_type == "Major_Depressive_Episode") %>%
ggplot2::ggplot(aes(x = Year, y = Percent,
color = Demographic)) +
geom_line(size = 1) +
labs(title = "Major Depressive Episode among Persons Aged 12 to 17",
subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
theme(legend.position = "bottom")
```

```{r}
MDE_total <- percents %>%
filter(data_type == "Major_Depressive_Episode",
Demographic == "TOTAL") %>%
ggplot(aes(x = Year, y = Percent, color = Demographic)) +
geom_line(aes(color = Demographic), size = 1.5) +
scale_x_continuous(breaks = seq(2004, 2018, by = 1),
labels = seq(2004, 2018, by = 1),
limits = c(2004, 2018)) +
labs(title = "Percent of Persons Aged 12 to 17 Reporting Having a \n Major Depressive Episode in the Past Year ") +
theme_classic() +
theme(axis.text.x = element_text(angle = 90),
legend.position = "none")
MDE_total
```

```{r}
MDE_total <- percents %>%
filter(data_type == "Major_Depressive_Episode", Demographic == "TOTAL") %>%
mutate(Demographic = recode(Demographic,
"TOTAL" = "Percent of respondents with MDE"))%>%
ggplot(aes(x = Year, y = Percent, group = Demographic)) +
facet_wrap( ~ Demographic)+
geom_rect(xmin = 2011, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "light gray") +
geom_line(aes(color = Demographic), size = 1.5) +
scale_x_continuous(breaks = seq(2004, 2018, by = 1),
labels = seq(2004, 2018, by = 1),
limits = c(2004, 2018)) +
labs(title = "The Rate of Youths Aged 12 to 17 Reporting Having a \n MDE is Increasi
ng")+
theme_classic() +
theme(axis.text.x = element_text(angle = 90),
legend.position = "none",
strip.background = element_rect(fill ="black"),
strip.text = element_text(face = "bold", size = 14, color = "white")) +
scale_color_manual(values = c("blue"))
MDE_total
```

```{r}
fs::dir_create(here("plots"))
save(MDE_total, file =here::here("plots", "MDE_total.rda"))
png(here::here("plots", "MDE_total.png"))
MDE_total
dev.off()
```

```{r}
MDE_total +geom_rect(xmin = 2011, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "light gray")
```

```{r}
ocs_theme <- function() {
theme_classic() +
theme(axis.text.x = element_text(angle = 90),
strip.background = element_rect(fill = "black"),
strip.text = element_text(face = "bold", size = 14, color = "white"))
}
```

```{r}
MDE_age_gender <-percents %>%
filter(data_type == "Major_Depressive_Episode",
subgroup != "Race/Ethnicity",
Demographic != "TOTAL") %>%
ggplot(aes(x = Year, y = Percent, color = Demographic)) +
geom_line(aes(color = Demographic), size = 1) +
scale_x_continuous(breaks = seq(2004, 2018, by = 1),
labels = seq(2004, 2018, by = 1),
limits = c(2004, 2018)) +
labs(title = "Major Depressive Episode among Persons Aged 12 to 17",
subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
facet_wrap(~ subgroup) +
ocs_theme()
MDE_age_gender
```

```{r}
MDE_age_gender <- directlabels::direct.label(
MDE_age_gender,
list(dl.trans(y = y + 0.38, x = x -0.1),
"far.from.others.borders",
cex = .8,
fontface=c("bold"),
dl.move("Age: 14-15", x = 2007, y = 9.7))
)
MDE_age_gender
```

```{r}
scales::show_col(scales::hue_pal()(6))
```

```{r}
scales::show_col(scales::hue_pal()(30))
```

```{r}
age_col_light <- c("#B79F00")
age_col<- c("#6BB100")
age_col_dark<- c("#00BD5F")
Female_col <-c("#F564E3")
Male_col <- c("#619CFF")
```

```{r}
MDE_age_gender <- MDE_age_gender +
scale_color_manual(values = c(age_col_light,
age_col,
age_col_dark,
Female_col,
Male_col))
MDE_age_gender
```

```{r}
MDE_age_gender <-
  percents %>%
  filter(data_type == "Major_Depressive_Episode", 
         subgroup != "Race/Ethnicity", 
         Demographic != "TOTAL") %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
    geom_rect(xmin = 2011, xmax = Inf,  
              ymin = -Inf, ymax = Inf,  
              fill = "light gray") +
    geom_line(aes(color = Demographic), size =1) +
    scale_x_continuous(breaks = seq(2004, 2018, by=1),
                       labels = seq(2004, 2018, by=1),
                       limits = c(2004, 2018)) +
    labs(title = "Major Depressive Episode\namong Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
    facet_wrap(~ subgroup) +
    ocs_theme()

MDE_age_gender <- direct.label(
  MDE_age_gender, 
  list(dl.trans(y = y +0.38, x = x -0.2), 
       "far.from.others.borders", 
       cex = .8,
       fontface = "bold",
       dl.move("Age: 14-15", x = 2008, y =10))
  ) + 
  scale_color_manual(values = c(age_col_light, 
                                age_col, 
                                age_col_dark, 
                                Female_col, 
                                Male_col))

MDE_age_gender
```

```{r}
save(MDE_age_gender, file =here::here("plots", "MDE_age_gender.rda"))
png(here::here("plots", "MDE_age_gender.png"))
MDE_age_gender
dev.off()
```

```{r}
MDE_race <- percents %>%
filter(data_type == "Major_Depressive_Episode",
subgroup == "Race/Ethnicity") %>%
mutate(Demographic = forcats::fct_reorder(Demographic, Percent,
tail, n = 1, .desc = TRUE)) %>%
ggplot(aes(x = Year, y = Percent, group = Demographic)) +
geom_rect(xmin=2011,xmax=Inf,ymin=-Inf,ymax = Inf, fill = "light gray") +
geom_line(aes(color = Demographic), size = 1) +
facet_wrap( ~ subgroup) +
scale_x_continuous(breaks = seq(2004, 2018, by = 1),
labels = seq(2004, 2018, by = 1),
limits = c(2004, 2018)) +
scale_color_viridis_d() +
labs(title = "Major Depressive Episode\namong Persons Aged 12 to 17",
subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
ocs_theme()
MDE_race
```

```{r}
MDE_race <- percents %>%
filter(data_type == "Major_Depressive_Episode",
subgroup == "Race/Ethnicity",
Demographic != "Native Hawaiian or Other Pacific Islander") %>%
  mutate(Demographic = fct_reorder(Demographic, Percent,
tail, n = 1, .desc = TRUE)) %>%
ggplot(aes(x = Year, y = Percent, group = Demographic)) +
geom_rect(xmin = 2011, xmax = Inf,
ymin = -Inf, ymax = Inf,
fill = "light gray") +
geom_line(aes(color = Demographic), size = 1) +
facet_wrap( ~ subgroup) +
scale_x_continuous(breaks = seq(2004, 2018, by = 1),
labels = seq(2004, 2018, by = 1),
limits = c(2004, 2018)) +
scale_color_viridis_d() +
labs(title = "Major Depressive Episode\namong Persons Aged 12 to 17",
subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
ocs_theme()
MDE_race
```

```{r}
save(MDE_race, file =here::here("plots", "MDE_race.rda"))
png(here::here("plots", "MDE_race.png"))
MDE_race
dev.off()
```

4.3

```{r}
MDES_age_gender <-
percents %>%
filter(data_type == "Severe_Major_Depressive_Episode",
subgroup != "Race/Ethnicity",
Demographic != "TOTAL") %>%
ggplot(aes(x = Year, y = Percent, group = Demographic)) +
geom_rect(xmin = 2011, xmax = Inf, ymin = -Inf, ymax = Inf, fill = "light gray") +
geom_line(aes(color = Demographic), size = 1)+
scale_x_continuous(breaks = seq(2006, 2018, by = 1), labels = seq(2006, 2018, by = 1),
limits = c(2006, 2018)) +
labs(title = "Major Depressive Episode with Severe Impairment\namong Persons Aged 12 to 17",
subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
facet_wrap( ~ subgroup) +
ocs_theme()
MDES_age_gender <- direct.label(
  MDES_age_gender,
list(dl.trans(y = y +0.39, x = x -0.1),
"far.from.others.borders",cex = .8, fontface = "bold",dl.move("Age: 14-15", x= 2016.5, y = 11))) +
scale_color_manual(values = c(age_col_light, age_col, age_col_dark, Female_col, Male_col))
```






```{r}
MDE_race <- percents %>%
  filter(data_type == "Major_Depressive_Episode", 
         subgroup == "Race/Ethnicity", 
         Demographic != "Native Hawaiian or Other Pacific Islander") %>%
  mutate(Demographic = fct_reorder(Demographic, Percent,
                                   tail, n = 1, .desc = TRUE)) %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
    geom_rect(xmin = 2011, xmax = Inf,   
              ymin = -Inf, ymax = Inf,   
              fill = "light gray") +
    geom_line(aes(color = Demographic), size = 1) +
    facet_wrap( ~ subgroup) +
    scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                       labels = seq(2004, 2018, by = 1),
                       limits = c(2004, 2018)) +
    scale_color_viridis_d() +
    labs(title = "Major Depressive Episode\namong Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
    ocs_theme()

MDE_race
```

4.4

```{r}
save(MDE_race, file =here::here("plots", "MDE_race.rda"))
png(here::here("plots", "MDE_race.png"))
MDE_race
dev.off()
```
 
```{r}
MDES_total <- percents %>%
  filter(data_type == "Severe_Major_Depressive_Episode",
         Demographic == "TOTAL") %>% 
  mutate(Demographic = recode(Demographic, 
             "TOTAL" = "Percent of respondents with Severe MDE")) %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
    geom_rect(xmin = 2011, xmax = Inf,  
              ymin = -Inf, ymax = Inf,  
              fill = "light gray") +
    geom_line(aes(color = Demographic), size = 1) +
    scale_x_continuous(breaks = seq(2006, 2018, by = 1),
                     labels = seq(2006, 2018, by = 1),
                     limits = c(2006, 2018)) +
    labs(title = "Major Depressive Episode with Severe Impairment\namong Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
    facet_wrap( ~ Demographic) +
    ocs_theme() +
    theme(legend.position = "none") +
    scale_color_manual(values = c("blue"))
```


```{r}
MDES_total
```

```{r}
MDES_age_gender <-
  percents %>%
  filter(data_type == "Severe_Major_Depressive_Episode", 
         subgroup != "Race/Ethnicity", 
         Demographic != "TOTAL") %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
    geom_rect(xmin = 2011, xmax = Inf,  
              ymin = -Inf, ymax = Inf,  
              fill = "light gray") +
    geom_line(aes(color = Demographic), size = 1)+
    scale_x_continuous(breaks = seq(2006, 2018, by = 1),
                      labels = seq(2006, 2018, by = 1),
                       limits = c(2006, 2018)) +
    labs(title = "Major Depressive Episode with Severe Impairment\namong Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
    facet_wrap( ~ subgroup) +
    ocs_theme()

MDES_age_gender  <- direct.label(
  MDES_age_gender, 
  list(dl.trans(y = y +0.39, x = x -0.1), 
       "far.from.others.borders",
       cex = .8, 
       fontface = "bold",
       dl.move("Age: 14-15", x= 2016.5, y = 11))
  ) +
  scale_color_manual(values = c(age_col_light, age_col, age_col_dark, Female_col, Male_col))
```

```{r, echo=FALSE}
MDES_age_gender
```

```{r}
Race_MDES <- percents %>%
  filter(data_type == "Severe_Major_Depressive_Episode", 
         subgroup == "Race/Ethnicity") %>%
  mutate(Demographic = 
           fct_reorder(Demographic, Percent, 
                       tail, n = 1, .desc = TRUE)) %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
    geom_rect(xmin = 2011, xmax = Inf,  
              ymin = -Inf, ymax = Inf,  
              fill = "light gray") +
    geom_line(aes(color = Demographic), size =1) +
    facet_wrap(~ subgroup) +
    scale_x_continuous(breaks = seq(2006, 2018, by = 1),
                       labels = seq(2006, 2018, by = 1),
                       limits = c(2006, 2018)) +
    labs(title = "Major Depressive Episode with Severe Impairment\namong Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics: Percentages, 2006-2018") +
    ocs_theme() +
    scale_color_viridis_d()
```

```{r, echo=FALSE}
Race_MDES
```

4.4

```{r}
Treat_total <- percents %>%
  filter(data_type == "Treatment", 
         Demographic == "TOTAL") %>%
  mutate(Demographic = recode(Demographic, 
             "TOTAL" = "Percent of MDE respondents with treatment")) %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
    geom_rect(xmin = 2011, xmax = Inf,  
              ymin = -Inf, ymax = Inf,   
              fill = "light gray") +
    geom_line(aes(color = Demographic), size = 1.5) +
    facet_wrap(~Demographic) +
    scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                       labels = seq(2004, 2018, by = 1),
                       limits = c(2004, 2018)) +
    labs(title = "The Rate of Youths Aged 12 to 17 Receiving Treatment after\nReporting Having a Major Depressive Episode is Increasing") +
    ocs_theme() +
    theme(legend.position = "none") +
    scale_color_manual(values = c("blue"))
```


```{r}
Treat_total
```

```{r}
save(Treat_total, file =here::here("plots", "Treat_total.rda"))
png(here::here("plots", "Treat_total.png"))
Treat_total
dev.off()
```

```{r}
treat <- percents %>%
  filter(data_type == "Treatment", 
         subgroup != "Race/Ethnicity", 
         subgroup != "Total") %>%
  ggplot(aes(x = Year, y = Percent, color = Demographic)) +
    geom_line(size = 1) +
    facet_wrap( ~ subgroup) +
    scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                       labels = seq(2004, 2018, by = 1),
                       limits = c(2004, 2018)) + 
    labs(title = "Receipt of Treatment for Depression among\nPersons Aged 12 to 17 with Major Depressive Episode",
         subtitle = "By Demographic Characteristics: Percentages, 2004-2018") +
    ocs_theme()

treat <- direct.label(
  treat, 
  list(dl.trans(y = y -1.5, x = x -0.4),
       "far.from.others.borders", 
       cex = .8, 
       fontface = "bold",
       dl.move("Age: 16-17", x = 2010, y = 42),
       dl.move("Age: 14-15", x = 2015, y = 38))
  ) +
  scale_color_manual(values = c(age_col_light, 
                                age_col, 
                                age_col_dark, 
                                Female_col, 
                                Male_col))
```


```{r}
treat
```



 
```{r}
Race_treat <- percents %>%
  filter(data_type == "Treatment") %>%
  filter(subgroup == "Race/Ethnicity") %>%
  mutate(Demographic = 
           fct_reorder(Demographic, Percent, 
                       tail, n = 1, .desc = TRUE)) %>%
  ggplot(aes(x = Year, y = Percent, color = Demographic)) +
    geom_line(size = 1) +
    facet_wrap( ~ subgroup) +
    scale_x_continuous(breaks = seq(2009, 2018, by = 1),
                       labels = seq(2009, 2018, by = 1),
                       limits = c(2009, 2018)) +
    labs(title = "Receipt of Treatment for Depression among\nPersons Aged 12 to 17 with Major Depressive Episode",
         subtitle = "By Demographic Characteristics: Percentages, 2004-2018") +
    ocs_theme() +
    scale_color_viridis_d()
```


```{r, echo=FALSE}
Race_treat
```

4.5

```{r}
plotMHS <- table11.1b %>%
  filter(stringr::str_detect(short_label, "total") ) %>%
  ggplot(aes(x = Year, y = Percent, 
             group = MHS_setting, color = short_label)) +
    geom_line(size = 1) +
    facet_wrap( ~ type) +
    scale_x_continuous(breaks = seq(2009, 2018, by = 1),
                                labels = seq(2009, 2018, by = 1),
                                limits = c(2009, 2018)) +
    labs(title = "Settings Where Mental Health Services Were Received\namong Persons Aged 12 to 17",
         subtitle = "Percentages, 2002-2018") +
    ocs_theme()

plotMHS <- direct.label(
  plotMHS, 
  list(dl.trans(y = y +0.35, x = x -0.1),
       "far.from.others.borders", 
       cex = .8, 
       dl.move("Outpatient total", x = 2015, y =11))
  )

plotMHS
```


```{r}
plotMHSS <- table11.1b %>%
  filter(!str_detect(short_label, "total")) %>%
  ggplot(aes(x = Year, y = Percent, 
         group = MHS_setting, color = short_label)) +
    geom_line(size = 1) +
    facet_wrap( ~ type) +
    scale_x_continuous(breaks = seq(2002, 2019, by = 1),
                       labels = seq(2002, 2019, by = 1),
                       limits = c(2002, 2019)) +
    labs(title = "Settings Where Mental Health Services Were Received\namong Persons Aged 12 to 17",
         subtitle = "Percentages, 2002-2018") +
    ocs_theme() 

plotMHSS <- direct.label(
  plotMHSS, 
  list(dl.trans(y = y +0.3),
       "far.from.others.borders", 
       dl.move("School Therapist", 2010, 10), 
       dl.move("Fostercare", 2010, 1), 
       dl.move("Therapist", x=2009, y = 10.5))
  )

plotMHSS
```

4.6

```{r}
ggthemes::show_linetypes(scales::linetype_pal()(12), labels = TRUE)
```


```{r}
gender_outcomes <- 
  percents %>%
  filter(Demographic %in% c("Male", "Female", "TOTAL")) %>%
  ggplot(aes(x = Year, y = Percent, color = Demographic)) +
    geom_line(aes(linetype = data_type), size = 1) +
    scale_linetype_manual(values = c("solid", "2262", "13")) +
    scale_color_manual(values = c(Female_col, Male_col, "black")) +
    scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                       labels = seq(2004, 2018, by = 1),
                       limits = c(2004, 2018)) +
    labs(title = "Major Depressive Episodes and Treatment Among Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
    facet_wrap( ~ Demographic, strip.position = "top") +
  ocs_theme() +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
    guides(color = FALSE)

gender_outcomes 
```

```{r}
age_outcomes <-percents %>%
  filter(subgroup == "Age") %>%
  ggplot(aes(x = Year, y = Percent, color = Demographic)) +
    geom_line(aes(linetype= data_type), size = 1) +
    scale_linetype_manual(values = c("solid", "2262", "13")) +
    scale_color_manual(values = c(age_col_light, age_col, age_col_dark)) +
    scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                       labels = seq(2004, 2018, by = 1),
                       limits = c(2004, 2018)) +
    labs(title = "Major Depressive Episode\namong Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
    facet_wrap( ~ Demographic, strip.position = "top")+
  ocs_theme() +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
    guides(color = FALSE)
```

```{r, echo=FALSE}
age_outcomes
```

```{r}
race_outcomes <- percents %>%
  filter(subgroup == "Race/Ethnicity", 
         Demographic != "Native Hawaiian or Other Pacific Islander") %>%
  ggplot(aes(x = Year, y = Percent, color = Demographic)) +
    geom_line(aes(linetype = data_type), size=1) +
    scale_linetype_manual(values = c("solid", "2262", "13")) +
    scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                       labels = seq(2004, 2018, by = 1),
                       limits = c(2004, 2018)) +
    labs(title = "Major Depressive Episode\namong Persons Aged 12 to 17",
         subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
    facet_wrap( ~ Demographic, strip.position = "top", nrow = 4) +
  ocs_theme() +
  theme(legend.title = element_blank(),
        legend.position = "bottom") +
    guides(color = FALSE)
```

```{r, echo=FALSE, fig.height=10}
race_outcomes
```

5.1

```{r}
load(file = here::here("data", "wrangled", "wrangled_data.rda"))
```

5.2

```{r}
chi_squared_11.2a <- counts %>%
filter(data_type == "Major_Depressive_Episode") %>%
filter(Year %in% c(2004, 2018)) %>%
filter(Demographic %in% c("Male", "Female")) %>%
mutate(Number = Number * 1000) # because the numbers are in thousands
```

```{r}
chi_squared_11.2a %<>%
select(Demographic, Year, Number) %>%
tidyr::pivot_wider(names_from = Year,
names_prefix = "Year",
values_from = Number)
chi_squared_11.2a
```

```{r}
chi_squared_11.2a %<>%
tibble::column_to_rownames("Demographic")
chi_squared_11.2a
```

```{r}
stats::chisq.test(chi_squared_11.2a)
```

```{r}
t(chi_squared_11.2a)
t(chi_squared_11.2a) %>%
prop_test( detailed = TRUE, correct = TRUE) %>%
glimpse()
```

```{r}
MDE_age_gender_counts <-
counts %>%
filter(data_type == "Major_Depressive_Episode",
subgroup != "Race/Ethnicity",
Demographic != "TOTAL") %>%
ggplot(aes(x = Year, y = Number, group = Demographic)) +
geom_rect(xmin = 2011, xmax = Inf, ymin = -Inf, ymax = Inf,
fill = "light gray") +
geom_line(aes(color = Demographic), size =1) +
scale_x_continuous(breaks = seq(2004, 2018, by=1),
labels = seq(2004, 2018, by=1),
limits = c(2004, 2018)) +
labs(title = "Major Depressive Episode\namong Persons Aged 12 to 17",
subtitle = "By Demographic Characteristics, Percentages, 2004-2018") +
facet_wrap(~ subgroup) +
ocs_theme()
MDE_age_gender_counts <- direct.label(
MDE_age_gender_counts,
list(dl.trans(y = y +0.38, x = x -0.2), "far.from.others.borders",
cex = .8, fontface = "bold",
dl.move("Age: 14-15", x = 2008, y =10))) +
scale_color_manual(values = c(age_col_light, age_col, age_col_dark,
Female_col, Male_col))
MDE_age_gender_counts
```

5.3

```{r}
chi_squared_11.3a <- counts %>%
filter(data_type == "Severe_Major_Depressive_Episode",
Year %in% c(2006, 2018),
Demographic %in% c("Male","Female")) %>%
mutate(Number = Number * 1000) %>%
select(-data_type, -subgroup) %>%
pivot_wider(names_from = Year,
names_prefix = "Year",
values_from = Number) %>%
column_to_rownames("Demographic")
chi_squared_11.3a
```

```{r}
chisq.test(chi_squared_11.3a)
```

```{r}
t(chi_squared_11.3a)
```

```{r}
t(chi_squared_11.3a) %>%
prop_test( detailed = TRUE, correct = TRUE) %>%
glimpse()
```

7.1

```{r}
title_plots <-
ggdraw() +
draw_label(
"Self-Reported Depression Among American Youths",
fontface = 'bold',
size = 18,
x = 0,
hjust = -0.01)
```

```{r}
forward <- ggdraw() +
draw_label(
"The percentage of youths (age 12-17) experiencing major depressive episodes (MDE) has\nincreased sin
ce 2011. Of these youths, the percentage receiving treatment for depression has also\n increased but rema
ins limited to less than 42%.",
size = 16,
x = 0,
hjust = -0.01
)
```

```{r}
load(file = here::here("plots", "MDE_total.rda"))
load(file = here::here("plots", "Treat_total.rda"))
load(file = here::here("plots", "MDE_age_gender.rda"))
load(file = here::here("plots", "MDE_race.rda"))
```

```{r}
MDE_total_for_mp <- MDE_total +
theme(plot.title = element_blank(),
plot.subtitle = element_blank(),
axis.text = element_text(color = "black"))
treat_for_mp <-
Treat_total +
theme(plot.title = element_blank(),
      plot.subtitle = element_blank(),
axis.text = element_text(color = "black"))
MDE_age_gender_for_mp <-
MDE_age_gender +
theme(plot.title= element_text(size = 14, color = "black"),
plot.subtitle = element_blank(),
axis.text = element_text(color = "black")) +
labs(title = "Older youths and females report MDE at the highest rates\nand show the steepest increase"
)
```

```{r}
MDE_race_for_mp_leg <- MDE_race +
theme(plot.title= element_text(size = 14, color = "black"),
plot.subtitle = element_blank(),
axis.text = element_text(color = "black"),
legend.position = "right",
legend.title = element_blank(),
legend.text = element_text(size = 14)) +
labs(title = "All racial/ethnic groups show similar\nincreases since 2011") +
guides(color = guide_legend(ncol = 2))
legend <- get_legend(MDE_race_for_mp_leg +
theme(legend.justification = "right"))
```

```{r}
MDE_race_for_mp <- MDE_race_for_mp_leg + theme(legend.position = "none")
MDE_race_for_mp
```

```{r}
row_1 <- plot_grid(MDE_total_for_mp,
treat_for_mp,
nrow = 1)
row_2 <- plot_grid(MDE_age_gender_for_mp,
MDE_race_for_mp,
nrow = 1,
rel_widths = c(1, 0.6))
```

```{r}
summary_plot = plot_grid(title_plots, forward,
row_1, row_2,
legend,
ncol = 1, rel_heights = c(0.1,0.2,.8, 1, 0.3))
ggsave("summary_plot.png", plot = summary_plot, width = 10, height = 12, dpi = 100)
```

```{r}
MDE_gender <-percents %>%
  filter(data_type == "Major_Depressive_Episode", 
          subgroup == "Gender") %>%
  mutate(subgroup = recode(subgroup, "Gender" = 
         "Percent of each gender reporting MDE")) %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
  geom_rect(xmin = 2011, xmax = Inf,  
            ymin = -Inf, ymax = Inf,  
            fill = "light gray") +
  geom_line(aes(color = Demographic), size = 1.5) +
  facet_wrap(~subgroup) +
  scale_y_continuous(limits = c(0, 23))+
  scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                     labels = seq(2004, 2018, by = 1),
                     limits = c(2004, 2018)) +
 ocs_theme() +
 scale_color_manual(values = c(Female_col,
                               Male_col))



MDE_gender<- direct.label(
  MDE_gender, 
  list(dl.trans(y = y +0.38, x = x -0.2), 
       "far.from.others.borders", 
       cex = 1,
       fontface=c("bold"))
  )
       

MDE_age <- percents %>%
  filter(data_type == "Major_Depressive_Episode", 
          subgroup == "Age") %>%
  mutate(subgroup = recode(subgroup, "Age" = 
        "Percent of each age group reporting MDE")) %>%
  ggplot(aes(x = Year, y = Percent, group = Demographic)) +
  geom_rect(xmin = 2011, xmax = Inf,  
            ymin = -Inf, ymax = Inf,  
            fill = "light gray") +
  geom_line(aes(color = Demographic), size = 1.5) +
  facet_wrap(~subgroup)+
  scale_y_continuous(limits = c(0, 23))+
  scale_x_continuous(breaks = seq(2004, 2018, by = 1),
                     labels = seq(2004, 2018, by = 1),
                     limits = c(2004, 2018)) +
  ocs_theme() +
  scale_color_manual(values = c(age_col_light,
                                age_col,
                                age_col_dark))

MDE_age <- direct.label(
  MDE_age, 
  list(dl.trans(y = y + 0.38, x = x -0.2), 
       "far.from.others.borders", 
       cex = 1, 
       fontface=c("bold"),
       dl.move("Age: 12-13", x = 2015, y = 9))
  )
MDE_gender
MDE_age
```

```{r}
label <- expression(paste(
    bold("Older "), "youths and ",bold("females "),
 "report MDE at the highest rate and also show the steepest increase."), sep = "")

forward2 <- ggdraw() + draw_label(label, size = 16, x = 0,    hjust = -0.01  )
row_2 <- plot_grid(MDE_age, MDE_gender, nrow = 1)

summary_plot_final  = plot_grid(title_plots, forward, row_1, forward2, row_2,
          ncol = 1, 
          rel_heights = c(0.1, 0.2, 1, 0.1, 1))
# summary_plot_final
ggsave(here::here("plots", "summary_plot_final.png"), plot = summary_plot_final, 
       width = 10, height = 12, dpi = 100)
summary_plot_final
```

7.2

## **Paragraphe de conclusion**
Dans cette étude de cas, nous avons évalué les mesures autodéclarées des symptômes de la dépression chez les jeunes âgés de 12 à 17 ans aux États-Unis, ainsi que le taux de jeunes recevant un traitement pour la dépression. 
Nous avons appris à récupérer des données directement sur le web à l'aide du package `rvest` et nous avons appris à effectuer et à interpréter un test du ${\chi}^2$ à l'aide de la fonction `chisq.test()` du package `stats`.


# **Discussions : limitations**
Il convient de garder à l'esprit certaines considérations importantes concernant l'analyse des données : 

1. Les données que nous utilisons proviennent d'une enquête et sont donc des valeurs provenant d'un échantillon qui estime celui de la population réelle. Dans notre analyse statistique, nous utilisons ces valeurs d'échantillon comme s'il s'agissait d'estimations de la population (parce que c'est tout ce à quoi nous avons accès). Par conséquent, nos résultats ne sont pas nécessairement représentatifs des différences au sein de la population.
2. En outre, le mécanisme d'échantillonnage utilisé pour l'enquête peut introduire un [biais de sélection](https://en.wikipedia.org/wiki/Selection_bias?oldformat=true){target="_blank"} dans les cas où les [méthodes d'échantillonnage ne produisent pas un échantillon représentatif](https://en.wikipedia.org/wiki/Sampling_(statistics)?oldformat=true){target="_blank"}. 
3. Les données sont collectées auprès de participants humains, ce qui présente un *potentiel* de biais d'information, car il est *potentiel* que les participants de la [base de sondage](https://en.wikipedia.org/wiki/Sampling_frame?oldformat=true){target="_blank"} puissent, pour diverses raisons, fournir des informations inexactes.
4. Bien que le [genre et le sexe](https://www.who.int/genomics/gender/en/index.html) ne soient pas réellement binaires, les données utilisées dans cette analyse ne contiennent malheureusement que des informations sur les groupes d'individus qui se sont déclarés comme étant de sexe masculin ou féminin.

# **A vous! **
Extraire les tableaux 11.5A et 11.5B du site web, qui contiennent des données sur l'obtention d'un traitement chez les jeunes ayant déclaré avoir eu un épisode grave. 
Créer des graphiques et d'effectuer des tests du ${\chi}^2$ pour évaluer la comparaison des groupes au fil du temps.
